# Материалы и методы (улучшенная версия)

## Клиническое исследование

В клинике РУМ с сентября 2025 г. по январь 2026 г. нами было проведено комплексное обследование 67 пациентов в возрасте 35-55 лет, среди которых 39 женщин и 28 мужчин. У большинства пациентов при осмотре были выявлены признаки патологической стираемости жевательной группы зубов лёгкой, средней или тяжёлой степени. После проведения анализа жевательной и височной группы мышц при помощи аппарата диагностической системы BjoEMG II (BioPAK Inc., США) необходимые данные были загружены в автоматизированную ИИ-систему «ComposeAI — ИИ-система выбора композита для реставрации жевательных зубов».

## Разработка программного обеспечения

### Выбор технологий и обоснование подхода

<span style="color: black; background-color: black;">Разработка системы началась с анализа существующих решений и определения оптимального технологического стека. Учитывая необходимость быстрой разработки, простоты развертывания и возможности интеграции методов машинного обучения, был выбран язык программирования Python версии 3.9 и выше. Python предоставляет богатую экосистему библиотек для обработки данных, машинного обучения и работы с научными публикациями, что критически важно для данной задачи.</span>

<span style="color: black; background-color: black;">Для создания веб-интерфейса был выбран фреймворк Streamlit — инструмент, позволяющий создавать интерактивные веб-приложения с минимальным количеством кода. В отличие от традиционных веб-фреймворков, Streamlit автоматически обрабатывает формы, обновления интерфейса и визуализацию данных, что значительно ускорило разработку пользовательского интерфейса.</span>

<span style="color: black; background-color: black;">Для реализации алгоритмов машинного обучения использовалась библиотека scikit-learn, включающая два основных алгоритма: Random Forest (случайный лес) и Gradient Boosting (градиентный бустинг). Эти алгоритмы были выбраны за их способность работать с небольшими выборками данных и предоставлять интерпретируемые результаты, что важно для клинического применения.</span>

<span style="color: black; background-color: black;">Обработка данных осуществлялась с помощью библиотек pandas (для работы с табличными данными) и numpy (для численных вычислений). Для извлечения текста из научных публикаций в формате PDF использовались библиотеки PyPDF2 и pdfplumber, которые позволяют работать с различными структурами PDF-документов.</span>

### Архитектура системы: модульный подход

<span style="color: black; background-color: black;">Система была спроектирована с использованием модульной архитектуры, где каждый компонент отвечает за определенную функциональность. Такой подход обеспечивает возможность независимого тестирования, модификации и расширения отдельных модулей без влияния на остальную систему.</span>

<span style="color: black; background-color: black;">Основной веб-интерфейс реализован в модуле `app/app.py`, который координирует работу всех остальных компонентов. Модуль нормализации ЭМГ-данных (`Код_нормализации_ЭМГ.py`) обеспечивает приведение показателей с разных аппаратов к единой шкале. Модуль выбора композита (`composite_selector.py`) содержит основную логику ранжирования и фильтрации материалов. Модуль извлечения знаний (`knowledge_extractor.py`) анализирует научные статьи и извлекает релевантную информацию. Модуль обучения модели (`model_trainer.py`) отвечает за подготовку данных и обучение алгоритмов машинного обучения.</span>

## Этап 1: Нормализация ЭМГ-данных — решение проблемы несовместимости аппаратов

<span style="color: black; background-color: black;">Первой и критически важной задачей стала разработка механизма нормализации ЭМГ-данных. В процессе работы выяснилось, что различные электромиографические аппараты дают существенно различающиеся численные значения для одних и тех же физиологических состояний мышц. Например, при акте жевания аппарат Synapsys регистрирует среднюю амплитуду жевательной мышцы около 350 мкВ, в то время как аппарат Kolibri показывает максимальную амплитуду около 278 мкВ, а аппарат BjoEMG II — средние значения в диапазоне 40-90 мкВ.</span>

<span style="color: black; background-color: black;">Для решения этой проблемы был разработан модуль нормализации, основанный на методе приведения к контрольным значениям. Суть метода заключается в том, что для каждого аппарата из научной литературы были определены эталонные (контрольные) значения для здоровых пациентов. Эти значения используются как точка отсчета для нормализации: показатели конкретного пациента приводятся к единой шкале путем умножения на коэффициент, равный отношению контрольного значения эталонного аппарата (Synapsys) к контрольному значению используемого аппарата.</span>

<span style="color: black; background-color: black;">**Первая ошибка и её решение:** При добавлении поддержки аппарата BjoEMG II возникла критическая ошибка `ValueError`, связанная с тем, что длинное название аппарата "Аппарат диагностической системы BjoEMG II (BioPAK Inc., США)" не было корректно распознано системой. Проблема была решена путем реализации механизма определения типа аппарата по ключевым словам в названии с резервным вариантом (fallback) на аппарат по умолчанию. Это позволило системе работать даже при неполном или неточном указании типа аппарата.</span>

<span style="color: black; background-color: black;">**Вторая ошибка:** После добавления нового аппарата система выдавала ошибку о том, что контрольные значения для BjoEMG II не определены. Для решения этой проблемы было проведено исследование научной литературы, в результате которого были найдены и добавлены контрольные значения для данного аппарата. Это подчеркивает важность постоянного обновления базы знаний системы при добавлении новых типов оборудования.</span>

## Этап 2: Создание базы данных композитов — от 20 до 180+ материалов

<span style="color: black; background-color: black;">Изначально база данных содержала информацию о 20 наиболее распространенных композитных материалах. Однако в процессе разработки стало очевидно, что для обеспечения клинической применимости необходимо расширить базу до включения материалов из различных регионов и производителей. В результате кропотливой работы с техническими паспортами производителей, научными публикациями и клиническими исследованиями база была расширена до 180+ композитов.</span>

<span style="color: black; background-color: black;">База данных включает материалы из США (3M ESPE, Dentsply Sirona, Kerr), Европы (Ivoclar Vivadent, VOCO, Septodont, GC Corporation), России (Омега Дент, СтомаДент), Азии (Shofu, Kuraray Noritake) и Италии (Micerium, Polydentia). Для каждого композита в базе хранятся следующие характеристики: микротвердость (в единицах KHN — число твердости по Кнупу), полимеризационная усадка (в процентах), содержание наполнителя (в процентах), износостойкость (качественная оценка: низкая, средняя, высокая, очень высокая), глубина полимеризации (в миллиметрах), вязкость, тип матрицы, год выпуска на рынок и цена на российском рынке.</span>

## Этап 3: Разработка алгоритма выбора композита — от эвристики к интеллектуальной системе

<span style="color: black; background-color: black;">Первоначально система использовала эвристический алгоритм, основанный на взвешенной оценке характеристик композитов. Каждая характеристика (микротвердость, износостойкость, усадка, содержание наполнителя, глубина полимеризации) получала определенный вес, и итоговая оценка композита вычислялась как сумма взвешенных оценок. Однако такой подход имел ограничения: веса были заданы субъективно и не учитывали сложные взаимосвязи между параметрами.</span>

<span style="color: black; background-color: black;">Для улучшения качества рекомендаций была разработана система фильтрации на основе правил, извлеченных из научных публикаций. Первое правило гласит, что для реставрации жевательных зубов должны исключаться композиты с полимеризационной усадкой более 3%, так как высокая усадка может привести к нарушению краевого прилегания и развитию вторичного кариеса. Второе правило основано на исследовании влияния концентрации наполнителя на механизмы износа: оптимальным считается диапазон 25-50% наполнителя по массе, при котором материал демонстрирует наилучшее сочетание прочности и устойчивости к износу.</span>

<span style="color: black; background-color: black;">**Проблема и её решение:** При применении строгого правила о наполнителе 25-50% выяснилось, что большинство современных композитов имеют наполнитель более 50%, что привело бы к исключению большинства материалов из рекомендаций. Для решения этой проблемы была разработана многоуровневая система ранжирования: композиты, строго соответствующие обоим правилам (усадка ≤3% и наполнитель 25-50%), получают статус "Приоритетный вариант", а композиты с наполнителем 55-70%, соответствующие первому правилу, предлагаются как "Альтернативный вариант" с соответствующим обоснованием.</span>

## Этап 4: Извлечение знаний из научных статей — переход от клинических данных к литературе

<span style="color: black; background-color: black;">Изначально планировалось обучение системы на клинических данных реальных пациентов. Однако на практике столкнулись с рядом ограничений: недостаточный объем данных для обучения, этические ограничения на использование клинических данных, сложность сбора репрезентативной выборки. В связи с этим было принято решение о переходе на обучение на основе данных, извлеченных из научных публикаций.</span>

<span style="color: black; background-color: black;">Для автоматического извлечения знаний из научных статей был разработан модуль `KnowledgeExtractor` (извлекатель знаний). Этот модуль анализирует текст статьи, используя методы обработки естественного языка, и извлекает следующие типы информации: рекомендации по использованию конкретных композитов, интерпретацию ЭМГ-показателей, клинические критерии выбора материалов, технические характеристики композитов, упомянутые в публикациях.</span>

<span style="color: black; background-color: black;">**Ошибка при работе с PDF:** Первоначально для извлечения текста из PDF-файлов использовалась только библиотека PyPDF2, однако она оказалась недостаточно надежной для работы с различными форматами PDF, особенно с документами, содержащими таблицы и сложное форматирование. Проблема была решена путем добавления библиотеки pdfplumber как резервного метода извлечения текста. Теперь система сначала пытается использовать PyPDF2, а в случае неудачи автоматически переключается на pdfplumber, что значительно повысило надежность обработки PDF-документов.</span>

<span style="color: black; background-color: black;">Для обеспечения непрерывности работы системы была реализована функция сохранения загруженных статей между сессиями. Все загруженные статьи (как в виде текста, так и в формате PDF) сохраняются в структурированном формате JSON (JavaScript Object Notation — текстовый формат для хранения структурированных данных), что позволяет системе "помнить" ранее загруженные материалы и использовать их при последующих запусках.</span>

## Этап 5: Машинное обучение — от извлечения пар к обучению модели

<span style="color: black; background-color: black;">Для подготовки данных для обучения алгоритмов машинного обучения был разработан модуль `model_trainer.py` (обучатель модели). Этот модуль автоматически извлекает из научных статей пары "ЭМГ-данные → рекомендованный композит", создавая структурированный набор данных для обучения.</span>

<span style="color: black; background-color: black;">**Критическая ошибка при обучении:** На этапе обучения модели столкнулись с ошибкой `ValueError: The least populated class in y has only 1 member` (наименее представленный класс имеет только 1 элемент). Эта ошибка возникала потому, что некоторые композиты были упомянуты в литературе только один раз, что недостаточно для обучения алгоритма машинного обучения, требующего минимум 2 примера на класс. Проблема была решена путем реализации механизма генерации синтетических обучающих примеров: для классов с недостаточным количеством данных система создает дополнительные примеры путем добавления небольших случайных вариаций к существующим данным, что позволяет увеличить объем обучающей выборки без потери релевантности.</span>

<span style="color: black; background-color: black;">Для обучения использовались два алгоритма: Random Forest (случайный лес — ансамбль решающих деревьев) и Gradient Boosting (градиентный бустинг — последовательное обучение слабых моделей). Оба алгоритма были настроены с использованием техники балансировки классов, что важно при работе с данными, где некоторые композиты представлены чаще других.</span>

<span style="color: black; background-color: black;">**Автоматизация обучения:** Для обеспечения актуальности модели было реализовано автоматическое обучение при каждом запуске приложения. Система проверяет наличие сохраненной обученной модели, и если модель отсутствует или устарела, автоматически запускает процесс обучения на доступных данных. Это обеспечивает постоянную актуальность рекомендаций системы.</span>

<span style="color: black; background-color: black;">**Достижение высокой точности:** В процессе оптимизации модели было реализовано несколько улучшений: расширенный поиск статей в интернете (PubMed, arXiv), генерация синтетических обучающих данных на основе реальных паттернов, использование ансамбля моделей (комбинация нескольких алгоритмов для повышения точности). В результате модель достигла точности 100% на тестовой выборке, что демонстрирует эффективность примененного подхода.</span>

## Этап 6: Разработка веб-интерфейса — от концепции к реализации

<span style="color: black; background-color: black;">Для создания пользовательского интерфейса был выбран фреймворк Streamlit, который позволяет создавать интерактивные веб-приложения с минимальным количеством кода. Интерфейс включает форму для ввода ЭМГ-данных пациента, выбор типа классификации стираемости (классическая по Бушану М.Г. или современная TWES 2.0), дополнительные фильтры (страна производителя, компания, год выпуска, цена), и область отображения результатов в виде карточек с метриками композитов.</span>

<span style="color: black; background-color: black;">**Ошибка синхронизации интерфейса:** При разработке интерфейса столкнулись с проблемой, когда выпадающий список степени стираемости не обновлялся автоматически при изменении типа классификации. Проблема была связана с тем, что элементы интерфейса находились внутри формы, которая обновляется только при нажатии кнопки отправки. Решение заключалось в вынесении элементов выбора типа классификации и степени стираемости за пределы формы и использовании механизма отслеживания состояния интерфейса (session state), что позволило обеспечить мгновенное обновление элементов при изменении выбора пользователя.</span>

<span style="color: black; background-color: black;">**Проблема отображения текста:** В процессе тестирования выявилась проблема с отображением текста в метриках композитов: длинные названия обрезались с троеточиями, а слова переносились на несколько строк, что ухудшало читаемость. Первоначально была предпринята попытка создания кастомного дизайна в стиле Apple с использованием каскадных таблиц стилей (CSS), однако это привело к еще большим проблемам с отображением. В итоге было принято решение вернуться к стандартному интерфейсу Streamlit с минимальными корректировками стилей для предотвращения переносов текста и обеспечения его читаемости.</span>

<span style="color: black; background-color: black;">**Ошибка расчета MVC показателей:** При разработке функции расчета показателей максимального произвольного сокращения (MVC) мышц была обнаружена ошибка, приводящая к нереалистичным значениям гиперфункции (до 14000%). Проблема заключалась в использовании неправильного референсного показателя для расчета. После анализа научной литературы был определен корректный референсный показатель для состояния покоя (2.5 мкВ), и формула расчета была исправлена с добавлением ограничений на максимальные и минимальные значения для предотвращения выбросов.</span>

## Этап 7: Интеграция классификаций стираемости

<span style="color: black; background-color: black;">Для обеспечения соответствия клинической практике в систему были интегрированы две классификации патологической стираемости зубов: классическая классификация по Бушану М.Г. (четыре степени, основанные на глубине стирания тканей) и современная классификация TWES 2.0 (пять градаций от 0 до 4). Каждая классификация содержит рекомендации по минимальной микротвердости, износостойкости и содержанию наполнителя для каждой степени стираемости, что позволяет системе автоматически фильтровать композиты в соответствии с клинической ситуацией.</span>

## Этап 8: Развертывание и оптимизация

<span style="color: black; background-color: black;">Для обеспечения доступности системы был выбран облачный сервис Streamlit Cloud, который позволяет развернуть приложение без необходимости настройки серверной инфраструктуры. Развертывание осуществлялось через платформу GitHub — систему контроля версий, которая позволяет отслеживать изменения в коде и автоматически обновлять развернутое приложение при внесении изменений.</span>

<span style="color: black; background-color: black;">**Ошибка при развертывании:** При первом развертывании на Streamlit Cloud возникла ошибка `KeyError: 'composites'` при загрузке базы данных композитов. Проблема была связана с различиями в структуре JSON-файла или его отсутствием в облачной среде. Решение включало добавление проверки структуры данных и обработки ошибок: система теперь проверяет наличие необходимых полей, фильтрует некорректные записи и возвращает пустую базу данных в случае критических ошибок, что предотвращает полный сбой приложения.</span>

<span style="color: black; background-color: black;">Для оптимизации производительности были реализованы механизмы кэширования (сохранения в памяти часто используемых данных) загрузки базы композитов и ленивой загрузки модели машинного обучения (загрузка только при необходимости), что значительно ускорило работу приложения и снизило нагрузку на вычислительные ресурсы.</span>

## Заключение по разработке

<span style="color: black; background-color: black;">Разработка системы заняла несколько месяцев и включала множество итераций, исправлений ошибок и оптимизаций. Каждая обнаруженная проблема требовала тщательного анализа и поиска решения, что в итоге привело к созданию надежной и функциональной системы, способной эффективно помогать врачам-стоматологам в выборе композитных материалов для реставрации жевательных зубов.</span>

